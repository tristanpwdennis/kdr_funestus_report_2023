---
title: "kdr_analysis"
output:
  output: rmarkdown::github_document
date: "2024-07-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(emmeans)
library(ggeffects)
library(lme4)
library(tidyverse)
library(sf)
library(RColorBrewer)
library(ggrepel)
library(ggspatial)
library(ggsci)
library(data.table)

```

## Kdr in funestus MS. Tristan Dennis and Joel Odero 2024.07.29.

Joel Odero performed the collections, bioassays and models. Tristan Dennis wrote up this notebook for publication.

This markdown contains the code required to reproduce:
1. Map.
2. Bioassay data.
2. Allele frequency by location and timepoint, LD heatmap plots.

Let's start by plotting the map. You will need to download the rnaturalearth data to a directory of your choice.

```{r plotmap, echo=FALSE}
#load metadata
df_samples = read.csv('~/Projects/kdr_funestus_report_2023/metadata/df_samples.csv')
#load shapefiles
admin_shape = st_read("~/Projects/cease/cease_wp1c/analysis_data/raster/ne_10m_admin_1_states_provinces/ne_10m_admin_1_states_provinces.shp")
border_shape = st_read("~/Projects/cease/cease_wp1c/analysis_data/raster/ne_10m_admin_0_sovereignty/ne_10m_admin_0_sovereignty.shp")
lake = st_read("~/Projects/cease/cease_wp1c/analysis_data/raster//ne_50m_lakes/ne_50m_lakes.shp")
ocean_shape = st_read("~/Projects/cease/cease_wp1c/analysis_data/raster/ne_50m_ocean/ne_50m_ocean.shp")
#tidy lat and long
df_samples$newlong <- trunc(df_samples$longitude * 100) / 100
df_samples$newlat <- trunc(df_samples$latitude * 100) / 100
#subset sample df for plotting
tzdf <- df_samples %>% count(cohort_admin1_year, admin1_name, newlong, newlat)
#set colour palette ordering for admin1 region
colpal <- c('#d9d9d9','#fdb462','#fccde5','#bebada','#bc80bd','#ffffb3','#b3de69','#ccebc5','#8dd3c7','#80b1d3','#fb8072')
#plot map
map <- ggplot()+
 geom_sf(data = border_shape, fill = ifelse(border_shape$ADM0_A3 == "TZA", gray(0.98), gray(0.85)),col =gray(0.7)) + 
  geom_sf(data=st_geometry(lake),colour = '#4a80f5', fill='#9bbff4')+
  geom_point(data=tzdf, aes(x=as.numeric(newlong), y=as.numeric(newlat), colour=admin1_name, size=as.numeric(n)),  alpha = 0.7,size=5)+#colour=query))+#size=sequenced_count))+
  scale_colour_manual(values = colpal)+
  xlim(30, 40.5)+
  ylim(-11.6,-0.8)+
  labs(x="Longitude", y="Latitude", colour='Admin1')+
  theme_minimal()+
  annotation_scale(location = "bl", width_hint = 0.5) +
  labs(x = "Longitude", y = "Latitude", colour="Collection Admin1 Region") +
  theme_bw() +
  #scale_color_brewer(palette = "Paired")+
  theme(panel.background = element_rect(fill = "#9bbff4"),
        panel.grid.major = element_line(colour = gray(0.5), linetype = "dashed"),
        panel.border = element_rect(fill = NA),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 14, face = "bold"), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        #legend.position = "bottom", 
        legend.text = element_text(size = 11),
        legend.title = element_text(size = 13, face = "bold")) +
  guides(fill = guide_legend(title = "Country", override.aes = list(size = 5)))
map
ggsave('~/Projects/kdr_funestus_report_2023/figures/map.tiff', plot=map, width = 200, height = 200, units = 'mm', device = 'tiff')
```

Now let's plot insecticide resistance phenotype. Read in bioassay data, model

```{r pressure, echo=FALSE, fig.width=6, fig.height=4}
irphendat <- read.csv('~/Projects/kdr_funestus_report_2023/notebooks_scripts/bioassay.1.csv', sep=",", header=T, check.names = FALSE)

irphendat$Insecticide<-as.factor(irphendat$Insecticide)
irphendat$Insecticide<-relevel(irphendat$Insecticide, ref="control")
#model0 <- glmer(cbind(Dead, Alive) ~  Insecticide*Region  + (1|Insecticide:Region :Replicate) + RH + 
#                   Temp , data = irphendat, family = binomial)

model3 <- glmer(cbind(Dead, Alive) ~  Insecticide*Region  + (1|Insecticide:Region :Replicate) , data = irphendat, family = binomial)

#model predictions using ggemmeans
prediction_model3 <- ggemmeans(model3, terms=c('Insecticide', 'Region')) 

#group.colors <- c(Kagera = "#E69F00", Katavi = "#56B4E9", Lindi ="#CC79A7", Morogoro = "#009E73", Mtwara = "#F0E442", Mwanza ='black' , Pwani ='#0072B2' , Ruvuma ='#D55E00' , Tanga ='#00AFBB')

DDT.colors <- c(Kagera = "#1f78b4", Katavi = "#b2df8a", 
                  Lindi ="#33a02c", Morogoro = "#fb9a99", 
                  Mtwara = "#e31a1c", Mwanza ='#fdbf6f' , 
                  Pwani ='#ff7f00' , Ruvuma ='#cab2d6', 
                  Tanga ='#6a3d9a' )


selected_items <- prediction_model3[prediction_model3$x %in% c('DDT'),]
                                    
bioassay.prediction <- ggplot(selected_items, aes(x = group, y = predicted, color = group)) +
  geom_boxplot(width = 0.6, position = position_dodge(0.8)) +
  geom_hline(yintercept =  0.98, linetype = "dashed", color = 'black')+
  geom_hline(yintercept =  0.90, linetype = "dashed", color = 'red')+
  theme(text = element_text(size =18, face = 'bold'))+
  theme(axis.text.x =  element_text(size =12,face = 'bold',angle =0))+
  theme(axis.text.y =  element_text(size =12,face = 'bold', angle =0))+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2, position = position_dodge(0.8)) +
  labs(title = "", x = '', y = "Mortality") +
  theme_classic ()+
  ylim(0, NA)+
  facet_wrap('x', ncol = 1)+
  scale_color_manual(values = DDT.colors)+
  labs(color = "Region")+
  #scale_x_discrete(labels = NULL)+
  theme(legend.position = "bottom", legend.direction = "horizontal")
bioassay.prediction
######################################
```

We can see that DDT is significantly associated with survivorship in Morogoro region. Kagera has an interesting signal for DM+PBO too. Let's model and plot the data for the DDT bioassays.

Model 1: association of reduced mortality to DDT exposure with L976F vs wt vs heterozygote

```{r}
DDT<-read.csv("~/Projects/kdr_funestus_report_2023/tables/DDT_kdr.csv")
#models for plotting DDT
model976<-glm(Death~L967F, family=binomial, data=DDT)
model976_1<-glm(Death~1, family=binomial, data=DDT)
anova(model976_1, model976, test="Chisq")
summary(model976)
```

Model 2: association of reduced mortality to DDT exposure with P1842S vs wt vs heterozygote.

```{r}
model1842<-glm(Death~P1842S, family=binomial, data=DDT)
model1842_1<-glm(Death~1, family=binomial, data=DDT)
anova(model1842_1, model1842, test="Chisq")
summary(model1842)

```

Now let's do the same for DM

```{r}
#Now Deltametrin
# Read the CSV file
Delta967 <- read.csv("~/Projects/kdr_funestus_report_2023/tables/Deltamethrin_967.csv")

model976Delta<-glm(Death~L967F, family=binomial, data=Delta967)
summary(model976Delta)
```

Now let's do the same for DM and 1842S

```{r}
#Now Deltametrin
# Read the CSV file
Delta1842 <- read.csv("~/Projects/kdr_funestus_report_2023/tables/Deltamethrin_1842.csv")

model1842Delta<-glm(Death~P1842S, family=binomial, data=Delta1842)
summary(model1842Delta)
```

Now let's combine our model predictions together and make a nice plot.

```{r plotall, warning=FALSE}
prediction976<- ggemmeans(model976, terms=c("L967F"))
prediction976$insec <- "DDT"
prediction1842<- ggemmeans(model1842, terms=c("P1842S"))
prediction1842$insec<- "DDT"

#dm data
prediction976Delta<- ggemmeans(model976Delta, terms=c("L967F"))
prediction976Delta$x<- factor(prediction976Delta$x, levels = c("kdr", "heterozygote", "wt"))
prediction976Delta$insec <- "Deltamethrin"

prediction1842Delta<- ggemmeans(model1842Delta, terms=c("P1842S"))
prediction1842Delta$x<- factor(prediction1842Delta$x, levels = c("kdr", "heterozygote", "wt"))
prediction1842Delta$insec <- "Deltamethrin"

#coerce to factor for plotting
prediction976Delta$x<- factor(prediction976Delta$x, levels = c("kdr", "heterozygote", "wt"))
prediction976$x<- factor(prediction976$x, levels = c("kdr", "heterozygote", "wt"))

#bind everything together
kdrdf<- rbind(prediction976, prediction976Delta) 
deltadf <- rbind(prediction1842, prediction1842Delta)
deltadf$x <- factor(deltadf$x, levels = c("kdr", "heterozygote", "wt"))

#bind dm and ddt data together
deltadf$Mutation <- 'P1842S'
kdrdf$Mutation <- 'L976F'
mutdf <- rbind(deltadf, kdrdf)

tplot <- ggplot(NULL, aes())+
  geom_pointrange(data =mutdf, aes(x=x,y=predicted, ymin=conf.low,ymax=conf.high, colour=Mutation, shape=insec),position = position_dodge(width=0.2), size=1)+
  #ggtitle("DDT") +
  xlab(bquote('P1842S')) +
  ylab(bquote('Mortality')) +
  ylim(0,1) +
  labs(colour='Mutation',)+
  scale_colour_manual(values=c("#2ca25f","#2b8cbe"))+
  theme_classic(base_family='Arial', base_size = 18)+
  facet_grid(cols=vars(Mutation))+
  theme(strip.text.x = element_blank(),
        plot.title = element_text(size=30),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.line = element_blank(),
        )+
  labs(shape="Insecticide")+
  ggtitle("C")

tplot
```

Finally, let's plot our allele frequency and our LD heatmaps. 

```{r heatmaps, fig.width=12}
df_samples %>% select(admin1_name, admin1_iso) %>% unique()

#mak eplotting df
df_freqs <- fread('~/Projects/kdr_funestus_report_2023/tables/kdr_vgsc_aa_freqs.csv')
df_freqs_2 <- pivot_longer(df_freqs, cols=4:17)
df_freqs_2$name <- gsub('frq_','',df_freqs_2$name)
loc_df <- df_samples %>% select(cohort_admin1_year, admin1_name, year) %>% unique()
df_freqs_2 <- left_join(df_freqs_2, loc_df, by=c('name' = 'cohort_admin1_year'))
df_freqs_2$label <- factor(df_freqs_2$label, levels = c('L976F (3RL:44,125,475 T>A)','G1144C (3RL:44,122,391 C>A)','W1557R (3RL:44,117,167 A>T)','F1638Y (3RL:44,116,923 A>T)','N1773S (3RL:44,116,334 T>C)','P1842S (3RL:44,116,128 G>A)','G1962C (3RL:44,115,768 C>A)','I2030V (3RL:44,115,564 T>C)'))
plotheatmap <- function(admin){
  #plot initial heatmap to get labs and legend
  ggplot(df_freqs_2[df_freqs_2$admin1_name == admin,], aes(y=label, x=as.factor(year), fill=value))+
    geom_tile(colour='white', linewidth=0)+
    scale_fill_gradientn(colours = c("#f7fbff", '#9ecae1','#4292c6'), breaks = c(0,0.5,1), limits = c(0,1))+
    geom_text(aes(label=round(value, digits = 2)), color = "#08306b", size = 4, fontface = "bold") +
    theme_classic()+
    facet_grid(~admin1_name)+
    theme(legend.position = "none",
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.ticks.x = element_blank(), 
          axis.ticks.y = element_blank(),
          axis.line = element_blank(),
          axis.text.x = element_text(size=15,face="bold"),
          axis.text.y=element_text(size=15,face="bold"),
          strip.text.x = element_text(size=15,face="bold"),
          panel.border = element_blank(),
          panel.grid.minor = element_blank(),
          panel.spacing = element_blank(),
          
          plot.margin = margin(r = 0.05, l = 0.05))
          #axis.text.y = element_blank())
}

listofheatmaps <- lapply(unique(df_freqs_2$admin1_name), plotheatmap)

#have had to wrangle this to get a multipanelled heatmap without faffing around in inkscape
library(patchwork)
heatmaplot <- 
listofheatmaps[[2]]+scale_x_discrete(labels = "2022\n n=32")+  ggtitle("A")+ theme(plot.title = element_text(size=30))+
listofheatmaps[[6]]+theme(axis.text.y = element_blank(), axis.title.y = element_blank())+scale_x_discrete(labels = "2022\n n=28")+
listofheatmaps[[9]]+theme(axis.text.y = element_blank(), axis.title.y = element_blank())+scale_x_discrete(labels = "2022\n n=32")+
listofheatmaps[[1]]+scale_x_discrete(labels = "2022\n n=28")+theme(axis.text.y = element_blank(), axis.title.y = element_blank())+
listofheatmaps[[10]]+theme(axis.text.y = element_blank(), axis.title.y = element_blank())+scale_x_discrete(labels = "2022\n n=33")+ 
listofheatmaps[[7]]+theme(axis.text.y = element_blank(), axis.title.y = element_blank())+scale_x_discrete(labels = "2019\n n=10")+
listofheatmaps[[4]]+theme(axis.text.y = element_blank(), axis.title.y = element_blank())+scale_x_discrete(labels = c("2017\n n=10","2019\n n=18","2021\n n=9","2023\n n=27"))+
listofheatmaps[[3]]+theme(axis.text.y = element_blank(), axis.title.y = element_blank())+scale_x_discrete(labels = "2022\n n=30")+
listofheatmaps[[5]]+theme(axis.text.y = element_blank(), axis.title.y = element_blank())+scale_x_discrete(labels = "2022\n n=31")+
listofheatmaps[[8]]+theme(axis.text.y = element_blank(), axis.title.y = element_blank())+scale_x_discrete(labels = c("2019\n n=9","2022\n n=28"))+
plot_layout(widths =  c(1.2,1.2,1.2,1.2,1.2,1.2,4,1.2,1.2,2))             

heatmaplot        
```

REALLY finally, the LD plots:

```{r ld}
#get matrix labels sorted
headerlabs <- rev(c('snp2','L976F','G1144C','W1557R','F1638Y','N1773S','P1842S','G1962C','I2030V'))
snp2labs <- rev(c('L976F','G1144C','W1557R','F1638Y','N1773S','P1842S','G1962C','I2030V'))
ldmat <- read.csv('~/Projects/kdr_funestus_report_2023/data/kdrld.csv', header = FALSE)
ldmat$snp2 <- snp2labs
colnames(ldmat) <- headerlabs
snp2labs
#pivot to longfdorm df for plotting
lddf <- ldmat %>% pivot_longer(cols = 1:8)
lddf$snp2 <- factor(lddf$snp2, levels = snp2labs)
lddf$name <- factor(lddf$name, levels = snp2labs)

ldfig <- lddf %>% 
  ggplot(aes(x=name, y=snp2, fill=value))+
  geom_tile(colour='white', linewidth=0)+
  scale_fill_gradientn(colours = c("#f7fbff", '#9ecae1','#4292c6'), breaks = c(0,0.5,1), limits = c(-0.1,0.99))+
  geom_text(aes(label=round(value, digits = 2)), color = "#08306b", size = 4, fontface = "bold") +
  scale_y_discrete(position = "right")+
  theme_classic()+
  labs(fill = 'Rogers and Huff R')+
    theme(legend.position = "none",
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.ticks.x = element_blank(), 
          axis.ticks.y = element_blank(),
          plot.title = element_text(size=30),
          axis.line = element_blank(),
          strip.text.x = element_text(size=15,face="bold"),
          panel.border = element_blank(),
          panel.grid.minor = element_blank(),
          panel.spacing = element_blank(),
          plot.margin = margin(r = 0.1, l = 0.1),
          axis.text.x = element_text(size=15,face="bold",angle = 90,hjust=1),
          axis.text.y = element_text(size=15,face="bold",angle = 0, vjust = 0.1, hjust=1))+
  ggtitle("D")
ldfig
```